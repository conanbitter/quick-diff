<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            background-color: rgb(239, 242, 255);
            padding: 0;
        }

        .range {
            border-radius: 0.3em;
            padding: 0.2rlh;
            /*border: solid 1px;*/
        }

        .add {
            background-color: rgb(165, 214, 167);
            color: rgb(27, 94, 32);
            border-color: rgb(129, 199, 132);
        }

        .del {
            background-color: rgb(239, 154, 154);
            color: rgb(183, 28, 28);
            border-color: rgb(229, 115, 115);
        }

        .container {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            background-color: white;
            border: 1px solid rgb(200, 203, 233);
            padding: 10px;
            border-radius: 5px;
        }

        .container p {
            z-index: 1;
            position: relative;
            line-height: 1.5;
        }

        .highlight {
            position: absolute;
            border-left: solid 4px;
        }

        .line-add {
            background-color: rgb(200, 230, 201);
            border-color: rgb(46, 125, 50);
        }

        .line-del {
            background-color: rgb(255, 205, 210);
            border-color: rgb(198, 40, 40);
        }

        .line-mixed {
            background-color: rgb(255, 249, 196);
            border-color: rgb(249, 168, 37);
        }

        .sources-container {
            display: flex;
            width: 100%;
        }

        .source {
            flex: 1;
            border: 1px solid rgb(200, 203, 233);
            margin: 5px;
            padding: 5px;
            border-radius: 5px;
            resize: none;
            height: 20rem;
        }

        .source:focus {
            border: 2px solid rgb(120, 124, 170);
            margin: 4px;
            outline: none;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .button-container button {
            font-size: 200%;
            background-color: rgb(43, 136, 43);
            padding: 5px 15px;
            border-radius: 10px;
            border: darkslategray solid 2px;
            color: white;
        }
    </style>
</head>

<body>
    <script src="diff.js"></script>
    <script src="purify.js"></script>
    <h1>Quick Diff</h1>
    <div class="sources-container">
        <textarea class="source" placeholder="Before" id="comp1"></textarea>
        <textarea class="source" placeholder="After" id="comp2"></textarea>
    </div>
    <div class="button-container">
        <button id="tocompare">Compare</button>
    </div>
    <div class="container" id="container">

        <p id="text">
            Lorem <span class="range del">ipsum</span> dolor sit amet, <span class="range add">consectetur</span>
            adipiscing elit. In sed quam faucibus, posuere tortor ac,
            pellentesque
            elit. Aenean ac neque tellus. Integer nulla justo, blandit eget augue a, vulputate congue mauris. Proin sit
            amet
            diam <span class="range add">quis</span> odio <span class="range add">dignissim</span> vestibulum. Donec et
            convallis purus. Suspendisse laoreet nibh felis, sed pretium quam malesuada ut. Fusce commodo at tortor eu
            faucibus. <span class="range del">Mauris sed porta turpis.</span> Pellentesque mauris dui, commodo eu purus
            eleifend, dapibus blandit ex. Nullam fringilla, eros eget rutrum finibus, <span class="range add">urna
                dui</span> elementum ante, a vestibulum
            mi mauris et risus.
        </p>
    </div>
    <script>
        const container = document.getElementById('container');
        const textareaBefore = document.getElementById('comp1');
        const textareaAfter = document.getElementById('comp2');
        const segmenter = new Intl.Segmenter("ru", { granularity: "word" });


        function highlight_lines() {
            const spans_add = container.querySelectorAll('.add');
            const spans_del = container.querySelectorAll('.del');

            // create a container for highlight overlays
            const highlightContainer = document.createElement('div');
            highlightContainer.style.position = 'absolute';
            highlightContainer.style.top = '0';
            highlightContainer.style.left = '0';
            highlightContainer.style.width = '100%';
            highlightContainer.style.pointerEvents = 'none';
            highlightContainer.style.zIndex = '0'; // behind text
            container.style.position = 'relative';
            container.prepend(highlightContainer);

            const rectsByLine = new Map();

            spans_add.forEach(span => {
                const rects = span.getClientRects();
                for (const rect of rects) {
                    // Round top value to group lines
                    const lineTop = Math.round(rect.top);
                    if (!rectsByLine.has(lineTop)) {
                        rectsByLine.set(lineTop, { rect, kind: "add" });
                    }
                }
            });

            spans_del.forEach(span => {
                const rects = span.getClientRects();
                for (const rect of rects) {
                    // Round top value to group lines
                    const lineTop = Math.round(rect.top);
                    if (!rectsByLine.has(lineTop)) {
                        rectsByLine.set(lineTop, { rect, kind: "del" });
                    } else if (rectsByLine.get(lineTop).kind === "add") {
                        rectsByLine.set(lineTop, { rect, kind: "mix" });
                    }
                }
            });

            for (const { rect, kind } of rectsByLine.values()) {
                let color = 'line-mixed';
                /*if (kind === "add") {
                    color = 'line-add';
                } else if (kind === "del") {
                    color = 'line-del';
                }*/

                const highlight = document.createElement('div');
                highlight.className = 'highlight ' + color;
                highlight.style.left = `0px`;
                highlight.style.top = `${rect.top - container.getBoundingClientRect().top}px`;
                highlight.style.width = `${container.getBoundingClientRect().width - 6}px`;
                highlight.style.height = `${rect.height}px`;

                highlightContainer.appendChild(highlight);
            }
        }
        function escapeHTML(str) {
            return str.replace(/[&<>"'\/]/g, ch => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;'
            })[ch]);
        }


        const btnCompare = document.getElementById("tocompare");
        btnCompare.addEventListener("click", function () {
            const beforeText = textareaBefore.value;
            const afterText = textareaAfter.value;
            const diffs = Diff.diffWords(beforeText, afterText, { intlSegmenter: segmenter });
            let elements = [];
            for (const diff of diffs) {
                const value = escapeHTML(diff.value);
                if (diff.added) {
                    elements.push(`<span class="range add">${value}</span>`);
                } else if (diff.removed) {
                    elements.push(`<span class="range del">${value}</span>`);
                } else {
                    elements.push(value);
                }
            }

            const resultText = "<p>" + elements.join("").replace("\n", "</p><p>") + "</p>";

            container.setHTMLUnsafe(resultText);
            highlight_lines();
            //console.log(resultText);
        });
    </script>
</body>

</html>